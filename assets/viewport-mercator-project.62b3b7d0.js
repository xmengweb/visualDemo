import{g as f,_ as q,a as O,b as et,d as it,c as rt,e as z}from"./@babel.be5ddd47.js";import{B as at,W as nt,G as T,H as k,I as ot,K as st,X as ut,C as ht,Y as lt,Z as S,A as E,y as ct,k as R,_ as vt}from"./gl-matrix.c2437e13.js";function Z(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function N(a,n){var t=at([],n,a);return nt(t,t,1/t[3]),t}function w(a,n){if(!a)throw new Error(n||"viewport-mercator-project: assertion failed.")}var M=Math.PI,U=M/4,b=M/180,B=180/M,D=512,X=4003e4,dt=1.5;function G(a){return Math.pow(2,a)}function I(a,n){var t=f(a,2),r=t[0],e=t[1];w(Number.isFinite(r)&&Number.isFinite(n)),w(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude"),n*=D;var o=r*b,u=e*b,s=n*(o+M)/(2*M),h=n*(M-Math.log(Math.tan(U+u*.5)))/(2*M);return[s,h]}function W(a,n){var t=f(a,2),r=t[0],e=t[1];n*=D;var o=r/n*(2*M)-M,u=2*(Math.atan(Math.exp(M-e/n*(2*M)))-U);return[o*B,u*B]}function pt(a){var n=a.latitude,t=a.longitude,r=a.zoom,e=a.scale,o=a.highPrecision,u=o===void 0?!1:o;e=e!==void 0?e:G(r),w(Number.isFinite(n)&&Number.isFinite(t)&&Number.isFinite(e));var s={},h=D*e,i=Math.cos(n*b),l=h/360,v=l/i,c=h/X/i;if(s.pixelsPerMeter=[c,-c,c],s.metersPerPixel=[1/c,-1/c,1/c],s.pixelsPerDegree=[l,-v,c],s.degreesPerPixel=[1/l,-1/v,1/c],u){var d=b*Math.tan(n*b)/i,x=l*d/2,p=h/X*d,g=p/v*c;s.pixelsPerDegree2=[0,-x,p],s.pixelsPerMeter2=[g,0,g]}return s}function gt(a){var n=a.height,t=a.pitch,r=a.bearing,e=a.altitude,o=a.center,u=o===void 0?null:o,s=a.flipY,h=s===void 0?!1:s,i=Z();return T(i,i,[0,0,-e]),k(i,i,[1,1,1/n]),ot(i,i,-t*b),st(i,i,r*b),h&&k(i,i,[1,-1,1]),u&&T(i,i,ut([],u)),i}function ft(a){var n=a.width,t=a.height,r=a.altitude,e=r===void 0?dt:r,o=a.pitch,u=o===void 0?0:o,s=a.nearZMultiplier,h=s===void 0?1:s,i=a.farZMultiplier,l=i===void 0?1:i,v=u*b,c=Math.atan(.5/e),d=Math.sin(c)*e/Math.sin(Math.PI/2-v-c),x=Math.cos(Math.PI/2-v)*d+e;return{fov:2*Math.atan(t/2/e),aspect:n/t,focalDistance:e,near:h,far:x*l}}function mt(a){var n=a.width,t=a.height,r=a.pitch,e=a.altitude,o=a.nearZMultiplier,u=a.farZMultiplier,s=ft({width:n,height:t,altitude:e,pitch:r,nearZMultiplier:o,farZMultiplier:u}),h=s.fov,i=s.aspect,l=s.near,v=s.far,c=ht([],h,i,l,v);return c}function Mt(a,n){var t=f(a,3),r=t[0],e=t[1],o=t[2],u=o===void 0?0:o;return w(Number.isFinite(r)&&Number.isFinite(e)&&Number.isFinite(u)),N(n,[r,e,u,1])}function H(a,n){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r=f(a,3),e=r[0],o=r[1],u=r[2];if(w(Number.isFinite(e)&&Number.isFinite(o),"invalid pixel coordinate"),Number.isFinite(u)){var s=N(n,[e,o,u,1]);return s}var h=N(n,[e,o,0,1]),i=N(n,[e,o,1,1]),l=h[2],v=i[2],c=l===v?0:((t||0)-l)/(v-l);return lt([],h,i,c)}var V=Z(),xt=function(){function a(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=n.width,r=n.height,e=n.viewMatrix,o=e===void 0?V:e,u=n.projectionMatrix,s=u===void 0?V:u;O(this,a),this.width=t||1,this.height=r||1,this.scale=1,this.pixelsPerMeter=1,this.viewMatrix=o,this.projectionMatrix=s;var h=Z();E(h,h,this.projectionMatrix),E(h,h,this.viewMatrix),this.viewProjectionMatrix=h;var i=Z();k(i,i,[this.width/2,-this.height/2,1]),T(i,i,[1,-1,0]),E(i,i,this.viewProjectionMatrix);var l=ct(Z(),i);if(!l)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=i,this.pixelUnprojectionMatrix=l,this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}return q(a,[{key:"equals",value:function(t){return t instanceof a?t.width===this.width&&t.height===this.height&&S(t.projectionMatrix,this.projectionMatrix)&&S(t.viewMatrix,this.viewMatrix):!1}},{key:"project",value:function(t){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},e=r.topLeft,o=e===void 0?!0:e,u=this.projectPosition(t),s=Mt(u,this.pixelProjectionMatrix),h=f(s,2),i=h[0],l=h[1],v=o?l:this.height-l;return t.length===2?[i,v]:[i,v,s[2]]}},{key:"unproject",value:function(t){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},e=r.topLeft,o=e===void 0?!0:e,u=r.targetZ,s=f(t,3),h=s[0],i=s[1],l=s[2],v=o?i:this.height-i,c=u&&u*this.pixelsPerMeter,d=H([h,v,l],this.pixelUnprojectionMatrix,c),x=this.unprojectPosition(d),p=f(x,3),g=p[0],m=p[1],$=p[2];return Number.isFinite(l)?[g,m,$]:Number.isFinite(u)?[g,m,u]:[g,m]}},{key:"projectPosition",value:function(t){var r=this.projectFlat(t),e=f(r,2),o=e[0],u=e[1],s=(t[2]||0)*this.pixelsPerMeter;return[o,u,s]}},{key:"unprojectPosition",value:function(t){var r=this.unprojectFlat(t),e=f(r,2),o=e[0],u=e[1],s=(t[2]||0)/this.pixelsPerMeter;return[o,u,s]}},{key:"projectFlat",value:function(t){return arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.scale,t}},{key:"unprojectFlat",value:function(t){return arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.scale,t}}]),a}();function jt(a){var n=a.width,t=a.height,r=a.bounds,e=a.minExtent,o=e===void 0?0:e,u=a.maxZoom,s=u===void 0?24:u,h=a.padding,i=h===void 0?0:h,l=a.offset,v=l===void 0?[0,0]:l,c=f(r,2),d=f(c[0],2),x=d[0],p=d[1],g=f(c[1],2),m=g[0],$=g[1];if(Number.isFinite(i)){var F=i;i={top:F,bottom:F,left:F,right:F}}else w(Number.isFinite(i.top)&&Number.isFinite(i.bottom)&&Number.isFinite(i.left)&&Number.isFinite(i.right));var P=new bt({width:n,height:t,longitude:0,latitude:0,zoom:0}),j=P.project([x,$]),_=P.project([m,p]),L=[Math.max(Math.abs(_[0]-j[0]),o),Math.max(Math.abs(_[1]-j[1]),o)],y=[n-i.left-i.right-Math.abs(v[0])*2,t-i.top-i.bottom-Math.abs(v[1])*2];w(y[0]>0&&y[1]>0);var C=y[0]/L[0],Y=y[1]/L[1],K=(i.right-i.left)/2/C,J=(i.bottom-i.top)/2/Y,Q=[(_[0]+j[0])/2+K,(_[1]+j[1])/2+J],A=P.unproject(Q),tt=P.zoom+Math.log2(Math.abs(Math.min(C,Y)));return{longitude:A[0],latitude:A[1],zoom:Math.min(tt,s)}}var bt=function(a){et(n,a);function n(){var t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=r.width,o=r.height,u=r.latitude,s=u===void 0?0:u,h=r.longitude,i=h===void 0?0:h,l=r.zoom,v=l===void 0?0:l,c=r.pitch,d=c===void 0?0:c,x=r.bearing,p=x===void 0?0:x,g=r.altitude,m=g===void 0?1.5:g,$=r.nearZMultiplier,F=r.farZMultiplier;O(this,n),e=e||1,o=o||1;var P=G(v);m=Math.max(.75,m);var j=I([i,s],P);j[2]=0;var _=mt({width:e,height:o,pitch:d,bearing:p,altitude:m,nearZMultiplier:$||1/o,farZMultiplier:F||1.01}),L=gt({height:o,center:j,pitch:d,bearing:p,altitude:m,flipY:!0});return t=it(this,rt(n).call(this,{width:e,height:o,viewMatrix:L,projectionMatrix:_})),t.latitude=s,t.longitude=i,t.zoom=v,t.pitch=d,t.bearing=p,t.altitude=m,t.scale=P,t.center=j,t.pixelsPerMeter=pt(z(z(t))).pixelsPerMeter[2],Object.freeze(z(z(t))),t}return q(n,[{key:"projectFlat",value:function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.scale;return I(r,e)}},{key:"unprojectFlat",value:function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.scale;return W(r,e)}},{key:"getMapCenterByLngLatPosition",value:function(r){var e=r.lngLat,o=r.pos,u=H(o,this.pixelUnprojectionMatrix),s=I(e,this.scale),h=R([],s,vt([],u)),i=R([],this.center,h);return W(i,this.scale)}},{key:"getLocationAtPoint",value:function(r){var e=r.lngLat,o=r.pos;return this.getMapCenterByLngLatPosition({lngLat:e,pos:o})}},{key:"fitBounds",value:function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=this.width,u=this.height,s=jt(Object.assign({width:o,height:u,bounds:r},e)),h=s.longitude,i=s.latitude,l=s.zoom;return new n({width:o,height:u,longitude:h,latitude:i,zoom:l})}}]),n}(xt);export{bt as W};
